name: Production
on:
  workflow_dispatch:
  pull_request:
    types: [closed]

concurrency:
  group: production
  cancel-in-progress: true

jobs:
  frontend-production:
    if: github.event.pull_request.merged
    name: Frontend PRODUCTION
    runs-on: ubuntu-latest
    environment:
      name: frontend PRODUCTION
      url: https://veils.vercel.app/
    steps:
      # - name: Extract branch name
      #   shell: bash
      #   run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
      #   id: extract-branch
      - name: Extract branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract-branch
      - name: Checkout feature branch
        uses: actions/checkout@v2
        with:
          ref: ${{ steps.extract-branch.outputs.branch }}
      - name: "Deploy vercel"
        id: deploy
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
          vercel-args: "--prod"
      - name: Frontend Codecov Report
        uses: codecov/codecov-action@v2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          working-directory: ./frontend
          fail_ci_if_error: true
